{{- if .Values.monitoring.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "todo-app.fullname" . }}-alerts
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "todo-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: todo-app-alerts
      rules:
        # Alert 1: High API error rate (>5% of requests returning 5xx)
        - alert: HighAPIErrorRate
          expr: |
            sum(rate(http_requests_total{job="todo-backend", status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="todo-backend"}[5m]))
            > 0.05
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "High API error rate detected"
            description: "More than 5% of API requests are failing with 5xx errors for the last 2 minutes."

        # Alert 2: API response latency > 2s (p95)
        - alert: HighAPILatency
          expr: |
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job="todo-backend"}[5m])) by (le))
            > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High API latency detected"
            description: "95th percentile API latency exceeds 2 seconds for the last 5 minutes."

        # Alert 3: Consumer lag > 1000 messages
        - alert: KafkaConsumerLag
          expr: |
            kafka_consumer_group_lag{group=~"todo-.*"} > 1000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Kafka consumer lag is high"
            description: "Consumer group {{ "{{ $labels.group }}" }} has a lag of {{ "{{ $value }}" }} messages."

        # Alert 4: Pod restarts > 3 in 15 minutes
        - alert: PodCrashLooping
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="{{ .Values.global.namespace }}"}[15m]) > 3
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: "Pod is crash-looping"
            description: "Pod {{ "{{ $labels.pod }}" }} has restarted {{ "{{ $value }}" }} times in 15 minutes."
{{- end }}
